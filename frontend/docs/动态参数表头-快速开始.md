# åŠ¨æ€å‚æ•°è¡¨å¤´ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹

### 1. å®‰è£…å¯é€‰ä¾èµ–ï¼ˆæ¨èï¼‰

DOMPurify ç”¨äºæ¸…ç† HTML æ ‡ç­¾ï¼Œé˜²æ­¢ XSS æ”»å‡»ï¼š

```bash
cd frontend
npm install dompurify @types/dompurify
```

> æ³¨æ„ï¼šå¦‚æœä¸å®‰è£… DOMPurifyï¼Œå·¥å…·å‡½æ•°ä¾ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œåªæ˜¯ä¸ä¼šè¿›è¡Œ HTML æ¸…ç†ã€‚

---

### 2. åŸºç¡€ä½¿ç”¨

```tsx
import React, { useState, useEffect } from 'react';
import { Table } from 'antd';
import { generateDynamicParameterColumns } from '@/utils/parameterUtils';
import type { ColumnsType } from 'antd/es/table';

const ComponentTable = () => {
  const [components, setComponents] = useState([]);
  const [parameterDefinitions, setParameterDefinitions] = useState([]);

  // åŠ è½½æ•°æ®
  useEffect(() => {
    // ä»APIåŠ è½½å‚æ•°å®šä¹‰
    fetch('/api/doeeet/parameter-definitions')
      .then(res => res.json())
      .then(data => setParameterDefinitions(data.data));
    
    // ä»APIåŠ è½½ç»„ä»¶æ•°æ®
    fetch('/api/doeeet/search?familyPath=Microcircuits')
      .then(res => res.json())
      .then(data => setComponents(data.data.components));
  }, []);

  // é™æ€åˆ—
  const staticColumns: ColumnsType<any> = [
    { title: 'å™¨ä»¶å‹å·', dataIndex: 'partNumber', key: 'partNumber', width: 150 },
    { title: 'åˆ¶é€ å•†', dataIndex: 'manufacturer', key: 'manufacturer', width: 120 },
  ];

  // åŠ¨æ€å‚æ•°åˆ—
  const dynamicColumns = generateDynamicParameterColumns(
    parameterDefinitions,
    {
      columnWidth: 150,
      ellipsis: true,
      sortable: true,
    }
  );

  // åˆå¹¶åˆ—
  const columns = [...staticColumns, ...dynamicColumns];

  return (
    <Table
      columns={columns}
      dataSource={components}
      scroll={{ x: 'max-content' }}
    />
  );
};
```

---

### 3. è¡¨å¤´å±•ç¤ºæ•ˆæœ

#### æœ‰ `short_name` çš„æƒ…å†µ

```json
{
  "name": "Number of Pins",
  "short_name": "#Pins"
}
```

**è¡¨å¤´æ˜¾ç¤º**: `#Pins`  
**é¼ æ ‡æ‚¬åœ**: æ˜¾ç¤º `Number of Pins`

#### æ—  `short_name` çš„æƒ…å†µ

```json
{
  "name": "TNID Comments",
  "short_name": ""
}
```

**è¡¨å¤´æ˜¾ç¤º**: `TNID Comments`

#### HTML æ ‡ç­¾æ”¯æŒ

```json
{
  "name": "Storage Temperature Range",
  "short_name": "T<sub>STG</sub>"
}
```

**è¡¨å¤´æ˜¾ç¤º**: T<sub>STG</sub> ï¼ˆä¸‹æ ‡æ•ˆæœï¼‰

---

## ğŸ“– APIå‚è€ƒ

### `generateDynamicParameterColumns()`

ç”ŸæˆåŠ¨æ€å‚æ•°åˆ—é…ç½®ã€‚

**å‚æ•°**:
```typescript
generateDynamicParameterColumns<T>(
  parameterDefinitions: ParameterDefinition[],
  options?: {
    columnWidth?: number;          // åˆ—å®½åº¦ï¼Œé»˜è®¤120
    minColumnWidth?: number;       // æœ€å°åˆ—å®½ï¼Œé»˜è®¤80
    ellipsis?: boolean;            // è¶…é•¿çœç•¥ï¼Œé»˜è®¤true
    sortable?: boolean;            // å¯æ’åºï¼Œé»˜è®¤false
    filterable?: boolean;          // å¯ç­›é€‰ï¼Œé»˜è®¤false
    renderValue?: (value: any, param: ParameterDefinition) => React.ReactNode;
  }
): ColumnType<T>[]
```

**ç¤ºä¾‹**:
```tsx
const dynamicColumns = generateDynamicParameterColumns(
  parameterDefinitions,
  {
    columnWidth: 180,
    sortable: true,
    renderValue: (value, param) => {
      if (param.category === 'Mechanical Data') {
        return <strong>{value}</strong>;
      }
      return value;
    },
  }
);
```

---

### `generateParameterColumnTitle()`

ç”Ÿæˆå•ä¸ªå‚æ•°åˆ—çš„è¡¨å¤´ã€‚

**å‚æ•°**:
```typescript
generateParameterColumnTitle(
  name: string,
  shortName?: string,
  options?: {
    sanitizeHtml?: boolean;         // æ˜¯å¦æ¸…ç†HTMLï¼Œé»˜è®¤true
    tooltipPlacement?: 'top' | 'bottom' | 'left' | 'right';
  }
): React.ReactNode
```

**ç¤ºä¾‹**:
```tsx
{
  title: generateParameterColumnTitle('Number of Pins', '#Pins'),
  dataIndex: 'numPins',
  key: 'numPins',
}
```

---

### `generateGroupedParameterColumns()`

æŒ‰åˆ†ç±»ç”Ÿæˆåˆ†ç»„çš„å‚æ•°åˆ—ã€‚

**å‚æ•°**:
```typescript
generateGroupedParameterColumns<T>(
  parameterDefinitions: ParameterDefinition[],
  options?: { /* åŒ generateDynamicParameterColumns */ }
): ColumnType<T>[]
```

**ç¤ºä¾‹**:
```tsx
const groupedColumns = generateGroupedParameterColumns(parameterDefinitions);

// è¡¨å¤´æ•ˆæœï¼š
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Mechanical Data  â”‚ Electrical Char.     â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ #Pins  â”‚ Package â”‚ T_STG    â”‚ V_CC      â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### `exportParametersToCSV()`

å¯¼å‡ºç»„ä»¶å‚æ•°ä¸º CSV æ ¼å¼ã€‚

**å‚æ•°**:
```typescript
exportParametersToCSV(
  components: any[],
  parameterDefinitions: ParameterDefinition[]
): string
```

**ç¤ºä¾‹**:
```tsx
import { exportParametersToCSV, downloadCSV } from '@/utils/parameterUtils';

const handleExport = () => {
  const csvContent = exportParametersToCSV(components, parameterDefinitions);
  downloadCSV(csvContent, 'components_export.csv');
};
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: æ ¹æ®åˆ†ç±»åŠ¨æ€åŠ è½½å‚æ•°

```tsx
const [selectedCategory, setSelectedCategory] = useState<string[]>([]);
const [parameterDefinitions, setParameterDefinitions] = useState([]);

useEffect(() => {
  if (selectedCategory.length > 0) {
    // æ ¹æ®åˆ†ç±»åŠ è½½å¯¹åº”çš„å‚æ•°å®šä¹‰
    fetch(`/api/doeeet/category-meta/${encodeURIComponent(JSON.stringify(selectedCategory))}`)
      .then(res => res.json())
      .then(data => setParameterDefinitions(data.data.meta));
  }
}, [selectedCategory]);
```

### åœºæ™¯2: è‡ªå®šä¹‰å‚æ•°æ¸²æŸ“

```tsx
const dynamicColumns = generateDynamicParameterColumns(
  parameterDefinitions,
  {
    renderValue: (value, param) => {
      // æ¸©åº¦å‚æ•°ï¼šæ˜¾ç¤ºä¸ºçº¢è‰²
      if (param.name.includes('Temperature')) {
        return <span style={{ color: '#ff4d4f' }}>{value}</span>;
      }
      
      // ç”µå‹å‚æ•°ï¼šæ˜¾ç¤ºä¸ºè“è‰²
      if (param.name.includes('Voltage')) {
        return <span style={{ color: '#1890ff' }}>{value}</span>;
      }
      
      // æ•°å€¼å‹ï¼šå³å¯¹é½
      if (typeof value === 'number') {
        return <span style={{ textAlign: 'right', display: 'block' }}>{value}</span>;
      }
      
      return value;
    },
  }
);
```

### åœºæ™¯3: å‚æ•°ç­›é€‰å’Œæ’åº

```tsx
const dynamicColumns = generateDynamicParameterColumns(
  parameterDefinitions,
  {
    sortable: true,
    filterable: true,
  }
);
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: è¡¨å¤´æ˜¾ç¤ºä¹±ç æˆ–HTMLæ ‡ç­¾

**ç—‡çŠ¶**: è¡¨å¤´æ˜¾ç¤º `<sub>STG</sub>` è€Œä¸æ˜¯ä¸‹æ ‡æ•ˆæœ

**è§£å†³**:
1. ç¡®è®¤ä½¿ç”¨äº† `dangerouslySetInnerHTML`
2. å®‰è£… DOMPurify: `npm install dompurify @types/dompurify`

### Q2: Tooltip ä¸æ˜¾ç¤º

**ç—‡çŠ¶**: é¼ æ ‡æ‚¬åœåœ¨ `short_name` ä¸Šæ²¡æœ‰æ˜¾ç¤ºå®Œæ•´çš„ `name`

**è§£å†³**:
æ£€æŸ¥ `short_name` æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²æˆ–åªæœ‰ç©ºæ ¼ï¼š
```tsx
const hasShortName = shortName && shortName.trim() !== '';
```

### Q3: è¡¨æ ¼åˆ—å¤ªå®½æˆ–å¤ªçª„

**ç—‡çŠ¶**: åŠ¨æ€åˆ—å®½åº¦ä¸åˆé€‚

**è§£å†³**:
è°ƒæ•´ `columnWidth` å’Œ `minColumnWidth` å‚æ•°ï¼š
```tsx
const dynamicColumns = generateDynamicParameterColumns(
  parameterDefinitions,
  {
    columnWidth: 200,      // é»˜è®¤å®½åº¦
    minColumnWidth: 100,   // æœ€å°å®½åº¦
  }
);
```

---

## ğŸ§ª æµ‹è¯•

```tsx
import { generateParameterColumnTitle } from '@/utils/parameterUtils';
import { render, screen } from '@testing-library/react';

test('æœ‰ short_name æ—¶æ˜¾ç¤º Tooltip', () => {
  const { container } = render(
    generateParameterColumnTitle('Number of Pins', '#Pins') as React.ReactElement
  );
  
  expect(screen.getByText('#Pins')).toBeInTheDocument();
});

test('æ—  short_name æ—¶ç›´æ¥æ˜¾ç¤º name', () => {
  const result = generateParameterColumnTitle('TNID Comments', '');
  expect(result).toBe('TNID Comments');
});
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åŠ¨æ€å‚æ•°è¡¨å¤´å±•ç¤ºè¯´æ˜](./åŠ¨æ€å‚æ•°è¡¨å¤´å±•ç¤ºè¯´æ˜.md) - è¯¦ç»†æ–‡æ¡£
- [DynamicParameterTableExample.tsx](../src/examples/DynamicParameterTableExample.tsx) - å®Œæ•´ç¤ºä¾‹ä»£ç 
- [Ant Design Table API](https://ant.design/components/table-cn/)

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ å·²ç»æŒæ¡äº†åŠ¨æ€å‚æ•°è¡¨å¤´çš„ä½¿ç”¨æ–¹æ³•ï¼

**ä¸‹ä¸€æ­¥**:
1. æŸ¥çœ‹å®Œæ•´ç¤ºä¾‹: `frontend/src/examples/DynamicParameterTableExample.tsx`
2. é›†æˆåˆ°ä½ çš„é¡µé¢: å‚è€ƒä¸Šé¢çš„ä½¿ç”¨åœºæ™¯
3. è‡ªå®šä¹‰æ ·å¼: ä¿®æ”¹ CSS ç±»å `.parameter-column-title`

---

**æœ€åæ›´æ–°**: 2025-10-31  
**ç‰ˆæœ¬**: v1.0

